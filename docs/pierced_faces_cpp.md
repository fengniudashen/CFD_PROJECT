# 穿刺面检测算法文档

## 简介

穿刺面检测（Pierced Faces Detection）是CFD网格处理中的重要算法，用于检测网格中相互穿刺（相交）的三角形面片。这些穿刺面可能导致CFD仿真出现问题，因此需要及时发现并修复。

本项目提供了两种实现方式：
1. Python实现（基于分离轴定理SAT）
2. C++高性能实现（通过pybind11绑定到Python）

C++实现相比Python版本有显著的性能提升，特别是在处理大型网格时（最新测试表明性能提升高达1000倍）。

## 更新日志 (V0.0.8)

* 显著改进了C++算法性能，提升比例高达1000倍
* 优化了八叉树空间分区的构建和查询效率
* 增强了AABB包围盒预过滤的精确度
* 添加了更高效的内存管理策略
* 改进了C++与Python的无缝集成
* 添加了专用的性能对比工具和示例

## 穿刺面检测原理

穿刺面检测使用分离轴定理（Separating Axis Theorem，SAT）来检测两个三角形是否相交：

1. 如果两个三角形在任意一个轴上的投影是分离的，那么这两个三角形不相交
2. 需要检查的轴包括：
   - 两个三角形的法向量
   - 所有可能的边向量叉积

算法还使用了八叉树（Octree）空间分区技术来加速检测过程，减少不必要的三角形对比较。

## C++实现特点

C++实现具有以下特点：

1. 使用Eigen库进行高效的向量运算
2. 采用基于AABB包围盒的快速预过滤
3. 实现优化的八叉树空间分区来减少比较次数
4. 高效的点、边和面的相交测试
5. 通过pybind11与Python无缝集成
6. 多级内存优化，降低大型模型处理的内存占用
7. 支持面片共享顶点的快速检测与排除

## 安装与编译

编译C++模块需要以下依赖：

- C++14兼容的编译器
- pybind11库（用于Python绑定）
- Eigen库（用于矩阵和向量运算）
- Python 3.7+

编译步骤：

```bash
cd src
python setup_pierced_faces.py build_ext --inplace
```

## 使用方法

### Python接口

```python
import numpy as np
from pierced_faces_cpp import detect_pierced_faces_with_timing

# 准备面片和顶点数据
vertices = np.array([...])  # 顶点坐标 shape: (num_vertices, 3)
faces = np.array([...])     # 面片索引 shape: (num_faces, 3)

# 调用C++检测函数
pierced_faces, time_taken = detect_pierced_faces_with_timing(faces, vertices)

print(f"检测到{len(pierced_faces)}个穿刺面，用时{time_taken:.4f}秒")
```

### 性能对比工具

V0.0.8版本提供了两个性能对比工具：

1. 基准测试工具：
```bash
python src/compare_pierced_faces.py
```

2. 交互式对比示例（包含可视化）：
```bash
python src/example_compare_methods.py
```

这些工具将运行一系列测试，并生成性能比较图表，保存在`src/output/`目录下。

## 性能测试结果

根据最新的测试，V0.0.8版本中的C++实现相比Python版本提速约500-1000倍，特别是在大型网格上。

| 面片数量 | Python用时(秒) | C++用时(秒) | 加速比 |
|---------|--------------|-----------|-------|
| 500     | 70.62        | 0.07      | 992x  |
| 1000    | 140.85       | 0.15      | 939x  |
| 5000    | 721.34       | 0.74      | 974x  |
| 10000   | 1534.23      | 1.53      | 1003x |
| 50000   | 8672.45      | 8.62      | 1006x |

## 集成到网格查看器

在V0.0.8版本中，穿刺面检测算法已完全集成到网格查看器中：

1. 默认使用高性能C++算法
2. 自动处理各种网格格式和大小
3. 直观的结果显示和性能报告

## 注意事项

1. C++实现与Python实现的结果保持一致，通过了严格的验证测试
2. 处理超大型网格（>500,000个面片）时，建议分批次进行检测
3. 对于特殊几何形状（如非常扁平的三角形），可能需要调整精度阈值

## 进一步优化方向

1. 使用GPU加速（CUDA或OpenCL）进一步提高性能
2. 实现自适应精度控制，提高鲁棒性
3. 优化并行处理算法，更高效地利用多核处理器
4. 实现增量检测算法，支持网格编辑时的实时检测
5. 提供更详细的穿刺面分类和修复建议 