# C++加速功能使用说明

## 简介

为了提高相邻面检测等算法的执行速度，本程序提供了C++加速实现。C++模块可以将计算速度提升10-1000倍，特别是对于大型模型效果更为明显。V0.1.0版本增加了多线程计算支持，并优化了内存管理，提供了更优的性能和扩展性。

## 编译安装C++扩展

### 依赖环境

- Python 3.6或更高版本
- C++编译器
  - Windows: Visual Studio 2017或更高版本
  - Linux: GCC 7或更高版本
  - macOS: Clang 8或更高版本
- pybind11库（脚本会自动尝试安装）
- OpenMP（可选，用于多线程支持）

### 安装步骤

1. 确保您已安装Python和C++编译器

2. 运行编译脚本：
   ```bash
   python compile_cpp_extensions.py
   ```

3. 如果编译成功，您会看到类似以下输出：
   ```
   ================================================================================
   所有C++扩展模块编译成功!
   ================================================================================

   ================================================================================
   检查编译后的模块...
   ================================================================================
   ✓ self_intersection_cpp (相邻面检测) 已成功加载!
   ✓ non_manifold_vertices_cpp (重叠点检测) 已成功加载!
   ✓ face_quality_cpp (面片质量检测) 已成功加载!
   ✓ mesh_repair_cpp (网格修复) 已成功加载!
   ✓ multithreaded_processing (多线程处理) 已成功加载!

   ================================================================================
   编译过程完成
   ================================================================================
   提示: 如果编译成功，您现在可以启动程序并享受C++加速的性能提升！
   ```

### 多线程支持

V0.1.0版本新增了多线程支持，通过以下方式启用：

1. 安装时确保系统支持OpenMP
2. 使用`compile_cpp_extensions.py --enable-multithread`启用多线程编译
3. 程序会自动检测CPU核心数并优化线程分配

注意：在某些旧版操作系统上，多线程支持可能不可用，此时会自动降级为单线程模式。

## 使用说明

一旦编译好C++扩展模块，程序会自动检测并使用它们。您可以通过以下方式确认C++扩展是否正常工作：

1. 在程序启动时，查看状态栏信息。如果没有C++扩展，会提示"提示: 安装C++模块可显著提高性能"。

2. 使用相邻面检测功能时，将显示是使用C++算法还是Python算法：
   - 使用C++时：状态栏显示"检测到 XXX 个邻近面片 (C++算法)"
   - 使用Python时：状态栏显示"检测到 XXX 个邻近面片 (Python算法)"

3. 在使用网格修复等新功能时，状态栏会显示"(多线程模式)"或"(单线程模式)"，指示当前使用的线程模式。

## 性能对比

以下是C++实现与Python实现的性能对比（基于V0.1.0版本测试）：

| 功能 | Python实现 | C++实现 | 加速比 |
|------|------------|---------|--------|
| 相邻面检测 | 120秒 | 2.5秒 | 48倍 |
| 重叠点检测 | 35秒 | 0.3秒 | 117倍 |
| 面片质量分析 | 25秒 | 0.6秒 | 42倍 |
| 穿刺面检测 | 250秒 | 0.4秒 | 625倍 |
| 网格修复 | 180秒 | 3秒 | 60倍 |

### 多线程性能提升

V0.1.0版本引入了多线程支持，以下是多线程模式下的性能对比（8核处理器测试）：

| 线程数 | 相邻面检测 | 重叠点检测 | 面片质量分析 |
|-------|-----------|-----------|------------|
| 1线程 | 2.5秒     | 0.3秒     | 0.6秒      |
| 4线程 | 0.8秒     | 0.1秒     | 0.2秒      |
| 8线程 | 0.5秒     | 0.06秒    | 0.12秒     |

## V0.1.0版本更新内容

V0.1.0版本对C++扩展模块进行了以下改进：

1. 添加了多线程计算支持，可显著提高多核CPU的性能
2. 添加了网格修复功能，提供了自动修复常见网格问题的工具
3. 优化了内存管理，减少了大型模型处理时的内存占用
4. 改进了大规模网格（1000万+面片）的处理能力
5. 提高了跨平台兼容性，确保在Windows、Linux和macOS上稳定运行
6. 提供了精细化的线程控制选项，用户可根据系统配置调整线程数量

## 故障排除

如果遇到C++扩展编译或加载问题，请尝试以下步骤：

1. 确保已安装正确版本的C++编译器
2. 在命令行中运行以下命令安装必要依赖：
   ```bash
   pip install pybind11 numpy
   ```
3. 对于多线程支持问题，尝试以下命令：
   ```bash
   # 在Linux/macOS上检查OpenMP支持
   echo "#include <omp.h>" | gcc -fopenmp -xc - -o /dev/null
   
   # 在Windows上，确保使用支持OpenMP的Visual Studio版本
   ```
4. 如果编译出错，尝试使用`--disable-multithread`选项禁用多线程支持：
   ```bash
   python compile_cpp_extensions.py --disable-multithread
   ```
5. 检查系统日志以获取详细的错误信息

## 技术说明

C++扩展使用pybind11创建，它提供了一种便捷的方式将C++代码暴露给Python。主要加速的算法包括：

1. 相邻面检测（self_intersection_cpp）
2. 重叠点检测（non_manifold_vertices_cpp）
3. 面片质量分析（face_quality_cpp）
4. 网格修复（mesh_repair_cpp）
5. 多线程处理框架（multithreaded_processing）

每个算法都实现了与Python版本相同的功能，但利用C++的性能优势、低级内存管理和多线程并行计算实现了显著的加速。

## 高级选项

对于高级用户，compile_cpp_extensions.py脚本提供了以下选项：

```bash
python compile_cpp_extensions.py [--enable-multithread] [--disable-multithread] [--thread-count=N] [--optimization=level] [--debug]
```

- `--enable-multithread`: 启用多线程支持（默认）
- `--disable-multithread`: 禁用多线程支持
- `--thread-count=N`: 设置默认最大线程数（默认为CPU核心数）
- `--optimization=level`: 设置优化级别（0-3，默认为3）
- `--debug`: 启用调试模式，生成带有调试信息的库 