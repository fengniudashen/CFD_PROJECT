# C++加速功能使用说明

## 简介

为了提高相邻面检测等算法的执行速度，本程序提供了C++加速实现。C++模块可以将计算速度提升10-1000倍，特别是对于大型模型效果更为明显。V0.1.0版本增加了多线程计算支持，并优化了内存管理，提供了更优的性能和扩展性。

## 编译安装C++扩展 (V0.1.1 推荐使用 setup.py)

### 依赖环境

- Python 3.6或更高版本
- C++编译器
  - Windows: Visual Studio 2017或更高版本 (推荐安装 [Microsoft C++ Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/))
  - Linux: GCC 7或更高版本
  - macOS: Clang 8或更高版本
- Python 开发库 (通常随 Python 安装)
- setuptools (脚本会自动尝试安装)
- pybind11 (脚本会自动尝试安装)
- OpenMP（可选，用于多线程支持，通常随现代编译器提供）

### 安装步骤

1.  **确保环境就绪**: 确认已安装 Python 和 C++ 编译器，并将编译器添加到系统路径中。
2.  **安装编译依赖**: 在项目根目录下打开终端，运行：
    ```bash
    pip install setuptools pybind11
    ```
3.  **执行编译**: 在项目根目录下，运行以下命令：
    ```bash
    python setup.py build_ext --inplace
    ```
    *   `--inplace` 参数会将编译好的模块 (`.pyd` on Windows, `.so` on Linux/macOS) 直接放在项目目录中，方便 Python 导入。

4.  **验证 (可选)**: 编译成功后，应该能在项目目录（或 `build` 子目录）中找到类似 `adjacent_faces_cpp.cp310-win_amd64.pyd` 的文件。启动程序时，检查状态栏或控制台输出，确认 C++ 模块被成功加载。

*注意: 如果之前使用过 `compile_cpp_extensions.py`，建议删除旧的编译产物 (如 `build` 目录和旧的 `.pyd`/`.so` 文件) 再使用 `setup.py` 重新编译。*

### 多线程支持 (来自 V0.1.0)

V0.1.0版本新增了多线程支持。`setup.py` 文件目前默认未显式启用 OpenMP，但如果您的编译器默认支持并启用 OpenMP，则 C++ 代码中的相关指令可能会生效。

## 使用说明

一旦编译好C++扩展模块，程序会自动检测并使用它们。您可以通过以下方式确认C++扩展是否正常工作：

1.  在程序启动时，查看状态栏信息。如果没有C++扩展，会提示"提示: 安装C++模块可显著提高性能"。
2.  使用相邻面检测功能时，将显示是使用C++算法还是Python算法（基于 V0.1.1 逻辑）：
    *   使用C++时：状态栏显示"检测到 XXX 个邻近面片 (C++算法)"
    *   使用Python时：状态栏显示"检测到 XXX 个邻近面片 (Python算法)"
3.  (来自 V0.1.0) 在使用网格修复等功能时，状态栏会显示"(多线程模式)"或"(单线程模式)"，指示当前使用的线程模式。

## 性能对比 (基于V0.1.0, 相邻面检测逻辑已更改)

*注意: V0.1.1 修改了相邻面检测逻辑，以下加速比可能发生变化。*

| 功能     | Python实现 | C++实现 (V0.1.0) | 加速比 (V0.1.0) |
| ------ | -------- | -------------- | --------------- |
| 相邻面检测  | 120秒     | 2.5秒          | 48倍            |
| 重叠点检测  | 35秒      | 0.3秒          | 117倍           |
| 面片质量分析 | 25秒      | 0.6秒          | 42倍            |
| 穿刺面检测  | 250秒     | 0.4秒          | 625倍           |
| 网格修复   | 180秒     | 3秒            | 60倍            |

### 多线程性能提升 (基于V0.1.0)

V0.1.0版本引入了多线程支持，以下是多线程模式下的性能对比（8核处理器测试）：

| 线程数 | 相邻面检测 (V0.1.0) | 重叠点检测 | 面片质量分析 |
| --- | --------------- | ----- | ------ |
| 1线程 | 2.5秒           | 0.3秒  | 0.6秒   |
| 4线程 | 0.8秒           | 0.1秒  | 0.2秒   |
| 8线程 | 0.5秒           | 0.06秒 | 0.12秒  |

## V0.1.1 版本更新内容

V0.1.1 版本对C++相邻面检测模块进行了以下改进：

1.  **相邻面检测逻辑重构**: 采用新的 Proximity 公式 `P = d / min(L_A, L_B)` 进行判断。
2.  **移除了相交判断**: 相邻性不再基于几何相交。
3.  **标准化编译**: 引入 `setup.py` 进行编译。

## 故障排除

如果遇到C++扩展编译或加载问题，请尝试以下步骤：

1.  确保已安装正确版本的C++编译器，并已添加到系统路径。
2.  确保已使用 `pip install setuptools pybind11` 安装了编译依赖。
3.  运行 `python setup.py build_ext --inplace` 命令，并查看终端输出的详细错误信息。
4.  尝试删除 `build` 目录和旧的 `.pyd`/`.so` 文件后重新编译。
5.  确认 Python 环境与编译的模块兼容 (例如，都是 64 位)。

## 技术说明

C++扩展使用pybind11创建，它提供了一种便捷的方式将C++代码暴露给Python。主要加速的算法包括：

1.  **相邻面检测 (`adjacent_faces_cpp`) (V0.1.1 逻辑更新)**
2.  重叠点检测 (`non_manifold_vertices_cpp` 或 `overlapping_points_cpp`)
3.  面片质量分析 (`face_quality_cpp`)
4.  穿刺面检测 (`pierced_faces_cpp`)
5.  (来自 V0.1.0) 网格修复 (`mesh_repair_cpp`)
6.  (来自 V0.1.0) 多线程处理框架 (`multithreaded_processing`)

每个算法都实现了与Python版本相同的功能，但利用C++的性能优势、低级内存管理和（可能的）多线程并行计算实现了显著的加速。

## 高级选项 (`setup.py`)

`setup.py` 文件可以进行扩展以支持更复杂的编译选项（例如，强制启用/禁用 OpenMP，设置不同的优化级别等），但当前版本提供了一个基础的、跨平台的配置。 